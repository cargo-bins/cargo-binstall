name: Release
on:
  push:
    branches:
      - main
    tags-ignore:
      - "*"

jobs:
  info:
    runs-on: ubuntu-latest
    # the commit message will look like: `release: {crate-name} v{version} (#{pr-number})`
    if: "startsWith(github.event.head_commit.message, 'release: ')"
    outputs:
      crate: ${{ steps.version.outputs.crate }}
      version: ${{ steps.version.outputs.version }}
      notes: ${{ fromJSON(steps.notes.outputs.notes_json) }}
    env:
      COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
    steps:
    - uses: actions/checkout@v3
    - name: Extract tag from commit message
      id: version
      run: .github/scripts/extract-tag-from-release-commit.sh
    - name: Extract release notes
      id: notes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPO: ${{ github.repository }}
      run: .github/scripts/extract-release-notes.sh

  tag:
    needs: info
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Push lib release tag
      if: "! startsWith(github.event.head_commit.message, 'release: cargo-binstall v')"
      uses: mathieudutour/github-tag-action@v6.1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        custom_tag: ${{ needs.info.outputs.version }}
        tag_prefix: ${{ needs.info.outputs.crate }}-
    - name: Push cli release tag
      if: "startsWith(github.event.head_commit.message, 'release: cargo-binstall v')"
      uses: mathieudutour/github-tag-action@v6.1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        custom_tag: ${{ needs.info.outputs.version }}
        tag_prefix: ''

  package:
    if: "startsWith(github.event.head_commit.message, 'release: cargo-binstall v')"
    needs:
    - info
    - tag

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    env:
      CARGO_TERM_COLOR: always
      CARGO_UNSTABLE_SPARSE_REGISTRY: "true"
      JUST_FOR_RELEASE: true

    steps:
    - uses: actions/checkout@v3
    - name: Install just
      uses: taiki-e/install-action@v2
      with:
        tool: just

    - name: Configure caching
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

    - run: just ci-toolchain
    - run: just ci-install-deps

    - name: Builds (mac)
      if: runner.os == 'macOS'
      run: |
        set -ex
        just target=x86_64-apple-darwin package
        just target=aarch64-apple-darwin package
        just package-lipo

    - name: Builds (linux)
      if: runner.os == 'Linux'
      run: |
        set -ex
        just target=x86_64-unknown-linux-gnu package
        just target=x86_64-unknown-linux-musl package
        just use-cross=true target=armv7-unknown-linux-musleabihf package
        just use-cross=true target=armv7-unknown-linux-gnueabihf package
        just use-cross=true target=aarch64-unknown-linux-musl package
        just use-cross=true target=aarch64-unknown-linux-gnu package

    - name: Builds (windows)
      if: runner.os == 'Windows'
      run: |
        set -ex
        just target=x86_64-pc-windows-msvc package
        just target=aarch64-pc-windows-msvc package

    - name: Publish release
      uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844
      with:
        tag_name: ${{ needs.info.outputs.version }}
        name: ${{ needs.info.outputs.version }}
        body: ${{ needs.info.outputs.notes }}
        append_body: false
        files: |
          packages/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
